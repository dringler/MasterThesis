import org.apache.jena.query.Query;
import org.apache.jena.query.QueryExecution;
import org.apache.jena.query.QueryExecutionFactory;
import org.apache.jena.query.QueryFactory;
import org.apache.jena.query.ResultSet;
import org.apache.jena.query.ResultSetFormatter;
import org.apache.jena.sparql.engine.http.QueryExceptionHTTP;
/**
* Query DBpedia for the Data Analysis of the Event Class.
*
* @author  Daniel Ringler
* @version 1.0
* @since   2016-11-01 
*/
public class QueryDBpedia {
	public static String service = "http://dbpedia.org/sparql";
	
	public static void main(String[] args) {
		//Model m = ModelFactory.createDefaultModel();
		
		//CHECK DBpedia connection
		String queryTest = "ASK {}";
		QueryExecution qeTest = QueryExecutionFactory.sparqlService(service, queryTest);
		
		try {
			if(qeTest.execAsk()) {
				System.out.println(service + " is up");
				// call method to count event classes
				countInstancesOfEventClasses();
			}
		// check connection catch block
		} catch (QueryExceptionHTTP e) {
			System.out.println(service + " is down");
		} finally {
			qeTest.close();
		}
	}
	
	 /**
	   * Count the instances of the event class and all subclasses.
	   * @param service URL of the SPARQL endpoint
	   * @return Nothing
	   */
	public static void countInstancesOfEventClasses() {
		// COUNT EVENT CLASSES
		//add all dbo:classes to the array
		String queryStringArray[] = {"Event",
									"Competition",			
									"Contest",
									"LifeCycleEvent",			
									"PersonalEvent",	
									"Birth",
									"Death",
									"Divorce",	
									"Marriage",
									"NaturalEvent",		
									"Earthquake",
									"SolarEclipse",		
									"StormSurge",
									"SocietalEvent",			
									"AcademicConference",		
									"Attack",
									"Convention",
									"Election",	
									"FilmFestival",		
									"Meeting",
									"MilitaryConflict",		
									"MusicFestival",
									"Rebellion",
									"SpaceMission",	
									"SportsEvent",
									"CyclingCompetition",	
									"FootballMatch",
									"GrandPrix",
									"InternationalFootballLeagueEvent",	
									"MixedMartialArtsEvent",
									"NationalFootballLeagueEvent",	
									"Olympics",
									"OlympicEvent",
									"Race",
									"CyclingRace",
									"HorseRace",
									"MotorRace",
									"Tournament",
									"GolfTournament",
									"SoccerTournament",
									"TennisTournament",
									"WomensTennisAssociationTournament",
									"WrestlingEvent"};
		//for each class in array
		for (String queryStringVar : queryStringArray) {
			//create queryString
			String queryString = "PREFIX dbo: <http://dbpedia.org/ontology/>\n" + 
					"SELECT\n" +
						"(COUNT(DISTINCT ?" + queryStringVar.toLowerCase() + ") AS ?"+queryStringVar.toLowerCase()+"C)\n"+ 
					"WHERE {\n" +
							"?"+ queryStringVar.toLowerCase() + " a dbo:"+queryStringVar +".\n" +
					"}";
			//System.out.println(queryString);
			//execute query
			queryDBpedia(queryString);	
		}
	}
	 /**
	   * Query DBpedia and print results.
	   * @param queryString 	Query to fire against the endpoint
	   * @return Nothing
	   */
	public static void queryDBpedia(String queryString) {
		Query query = QueryFactory.create(queryString);
		QueryExecution qe = QueryExecutionFactory.sparqlService(service, query);
		ResultSet results = qe.execSelect();
		//print output
		//System.out.println(ResultSetFormatter.asText(results));
		while (results.hasNext()) {
			String output = results.next().toString();
			System.out.println(output);
		}
		
	}
}